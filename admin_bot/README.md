# Admin Bot

Админ‑бот для управления панелью Remnawave из Telegram.  
Проект разделён на две части:

- `admin_bot/` — админ‑бот (этот репозиторий)
- `user_bot/` — пользовательский бот и база `subscription.db`

Бот позволяет управлять пользователями, промокодами, хостами, делать рассылку, получать статистику и следить за нагрузкой нод.

---

## Возможности

### Пользователи
- Создание пользователя в Remnawave + запись в `subscription.db`
- Пошаговая настройка:
  - `username` (строго **цифры = Telegram ID**)
  - срок действия (навсегда / месяц / неделя / 1 день по умолчанию)
  - лимит трафика в **ГБ**
  - `tag` (опционально)
  - `telegram_id` (опционально)
  - `hwid` лимит (опционально)
- Редактирование:
  - срок (`expire_at`) — обновляет и панель, и `subscription.db`
  - `username` — меняет и панель, и `telegram_id` в `subscription.db`
  - `hwid`, `tag`, лимит трафика — меняются только в панели
- Удаление пользователя из панели и из `subscription.db`

### Статистика
- Количество пользователей
- Сколько пользователей онлайн
- Таблица пользователей с `telegram_id` и количеством дней до окончания
- Пагинация

### Промокоды
- Создание промокода (вручную или генерация)
- Тип: `gift` / `days`
- Значение: **число дней**
- One‑time: да/нет
- Удаление по коду

### Рассылка
- Рассылка текста, фото или видео всем пользователям из `subscription.db`
- Батчинг и ограничение скорости

### Хосты
- Быстрое создание хоста с минимальными параметрами
- Выбор inbound (пагинация)
- Выбор нод (мультивыбор + пагинация)
- Выбор внутреннего сквада
- Исключение выбранного сквада из других хостов (по запросу)

### Мониторинг
- Проверка RAM (по `/api/system/stats`)
- Проверка offline‑нод
- Контроль числа пользователей в сквадах
- Антиспам: сообщения не чаще 1 раза в 5 минут

### Бэкапы
- Ежедневная отправка `subscription.db` админам в 17:00 МСК
- Авто‑подчистка старых бэкапов (оставляем 10 последних)

---

## Структура проекта

```
KairaVPN_admin_bot/
├─ admin_bot/         # админ‑бот
│  ├─ app/            # код
│  ├─ logs/           # логи
│  ├─ .env            # конфиг
│  ├─ .env.example    # пример конфига
│  └─ main.py         # запуск
├─ user_bot/
│  └─ data/
│     └─ subscription.db  # база пользователей/промокодов
└─ .venv              # виртуальное окружение Python
```

---

## Установка и запуск

1) Активируй виртуальное окружение:
```
source .venv/bin/activate
```

2) Установи зависимости:
```
pip install -r admin_bot/requirements.txt
```

3) Скопируй конфиг:
```
cp admin_bot/.env.example admin_bot/.env
```

4) Заполни `.env`

5) Запусти бота:
```
.venv/bin/python admin_bot/main.py
```

---

## Важно

- **username = Telegram ID** (только цифры).
- `subscription.db` — основная БД user‑бота, хранит пользователей/промокоды.
- При создании/обновлении пользователя **срок** синхронизируется в `subscription.db`.
- При изменении `username` меняется `telegram_id` в `subscription.db`.

---

## Технические заметки

- Для создания/редактирования используем API панели Remnawave.

---
